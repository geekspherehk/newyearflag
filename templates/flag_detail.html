{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <h1>ğŸ“‹ Flagè¯¦æƒ…</h1>
    <a href="/flags" class="btn btn-secondary">è¿”å›åˆ—è¡¨</a>
</div>

<div class="flag-detail">
    <div class="detail-header">
        <h2>{{ flag.title }}</h2>
        <span class="flag-status status-{{ flag.status }}">{{ flag.status }}</span>
    </div>
    
    <div class="detail-section">
        <h3>ğŸ“‹ æè¿°</h3>
        <p>{{ flag.description }}</p>
    </div>
    
    <div class="detail-grid">
        <div class="detail-item">
            <h4>ğŸ“… ç›®æ ‡æ—¥æœŸ</h4>
            <p>{{ flag.target_date }}</p>
        </div>
        <div class="detail-item">
            <h4>ğŸ“Š å½“å‰è¿›åº¦</h4>
            <p>{{ flag.progress }}%</p>
        </div>
        <div class="detail-item">
            <h4>ğŸ·ï¸ åˆ†ç±»</h4>
            <p>{{ flag.category }}</p>
        </div>
        <div class="detail-item">
            <h4>ğŸ“… åˆ›å»ºæ—¶é—´</h4>
            <p>{{ flag.created_date }}</p>
        </div>
    </div>
    
    <div class="detail-section">
        <h3>ğŸ“ˆ è¿›åº¦</h3>
        <div class="progress-bar-container">
            <div class="progress-bar" style="width: {{ flag.progress }}%">
                <span class="progress-text">{{ flag.progress }}%</span>
            </div>
        </div>
    </div>
    
    <div class="detail-section">
        <h3>ğŸ¯ å¯è¡Œæ€§åˆ†æ</h3>
        <div class="feasibility-card">
            <div class="feasibility-score">
                <span class="score-value">{{ flag.feasibility_score }}</span>
                <span class="score-total">/100</span>
            </div>
            <div class="feasibility-analysis">
                <p>{{ flag.feasibility_reason }}</p>
            </div>
        </div>
    </div>
    
    {% if flag.check_history %}
    <div class="detail-section">
        <h3>ğŸ“Š æ£€æŸ¥å†å²</h3>
        <div class="history-list">
            {% for record in flag.check_history %}
            <div class="history-item">
                <div class="history-date">{{ record.date }}</div>
                <div class="history-progress">è¿›åº¦: {{ record.progress }}%</div>
                {% if record.notes %}
                <div class="history-notes">{{ record.notes }}</div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <div class="detail-actions">
        <button onclick="showUpdateModal('{{ flag.id }}', {{ flag.progress }})" class="btn btn-primary">æ›´æ–°è¿›åº¦</button>
        <button onclick="deleteFlag('{{ flag.id }}')" class="btn btn-danger">åˆ é™¤Flag</button>
    </div>
</div>

<div class="modal" id="updateModal">
    <div class="modal-content">
        <span class="close" onclick="closeUpdateModal()">&times;</span>
        <h2>æ›´æ–°è¿›åº¦</h2>
        <form id="updateForm" onsubmit="submitUpdate(event)">
            <input type="hidden" id="updateFlagId">
            <div class="form-group">
                <label>è¿›åº¦ (0-100):</label>
                <input type="range" id="updateProgress" min="0" max="100" value="0" oninput="updateProgressLabel()">
                <span id="progressLabel">0%</span>
            </div>
            <div class="form-group">
                <label>å¤‡æ³¨:</label>
                <textarea id="updateNotes" rows="3" placeholder="è¾“å…¥å¤‡æ³¨ä¿¡æ¯..."></textarea>
            </div>
            <button type="submit" class="btn btn-primary">æ›´æ–°</button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function showUpdateModal(flagId, currentProgress) {
    document.getElementById('updateFlagId').value = flagId;
    document.getElementById('updateProgress').value = currentProgress;
    document.getElementById('progressLabel').textContent = currentProgress + '%';
    document.getElementById('updateModal').style.display = 'block';
}

function closeUpdateModal() {
    document.getElementById('updateModal').style.display = 'none';
}

function updateProgressLabel() {
    const progress = document.getElementById('updateProgress').value;
    document.getElementById('progressLabel').textContent = progress + '%';
}

function submitUpdate(event) {
    event.preventDefault();
    
    const flagId = document.getElementById('updateFlagId').value;
    const progress = document.getElementById('updateProgress').value;
    const notes = document.getElementById('updateNotes').value;
    
    fetch(`/update/${flagId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `progress=${progress}&notes=${encodeURIComponent(notes)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('è¿›åº¦æ›´æ–°æˆåŠŸï¼');
            closeUpdateModal();
            location.reload();
        } else {
            alert('æ›´æ–°å¤±è´¥ï¼š' + data.error);
        }
    })
    .catch(error => {
        alert('æ›´æ–°å¤±è´¥ï¼š' + error);
    });
}

function deleteFlag(flagId) {
    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªFlagå—ï¼Ÿ')) {
        fetch(`/delete/${flagId}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('åˆ é™¤æˆåŠŸï¼');
                window.location.href = '/flags';
            } else {
                alert('åˆ é™¤å¤±è´¥ï¼š' + data.error);
            }
        })
        .catch(error => {
            alert('åˆ é™¤å¤±è´¥ï¼š' + error);
        });
    }
}

window.onclick = function(event) {
    const modal = document.getElementById('updateModal');
    if (event.target == modal) {
        closeUpdateModal();
    }
}
</script>
{% endblock %}