{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <h1>ğŸ“‹ Flagåˆ—è¡¨</h1>
    <a href="/add" class="btn btn-primary">æ·»åŠ æ–°Flag</a>
</div>

<div class="filters">
    <div class="filter-group">
        <label>çŠ¶æ€ç­›é€‰ï¼š</label>
        <select id="statusFilter" onchange="filterFlags()">
            <option value="">å…¨éƒ¨</option>
            <option value="æœªå¼€å§‹" {% if current_status == 'æœªå¼€å§‹' %}selected{% endif %}>æœªå¼€å§‹</option>
            <option value="è¿›è¡Œä¸­" {% if current_status == 'è¿›è¡Œä¸­' %}selected{% endif %}>è¿›è¡Œä¸­</option>
            <option value="å·²å®Œæˆ" {% if current_status == 'å·²å®Œæˆ' %}selected{% endif %}>å·²å®Œæˆ</option>
        </select>
    </div>
    <div class="filter-group">
        <label>åˆ†ç±»ç­›é€‰ï¼š</label>
        <select id="categoryFilter" onchange="filterFlags()">
            <option value="">å…¨éƒ¨</option>
            {% for category in categories %}
            <option value="{{ category }}" {% if current_category == category %}selected{% endif %}>{{ category }}</option>
            {% endfor %}
        </select>
    </div>
</div>

<div class="search-box">
    <input type="text" id="searchInput" placeholder="æœç´¢Flag..." onkeyup="searchFlags()">
</div>

<div class="flag-grid">
    {% for flag in flags %}
    <div class="flag-card" data-status="{{ flag.status }}" data-category="{{ flag.category }}">
        <div class="flag-header">
            <h3>{{ flag.title }}</h3>
            <span class="flag-status status-{{ flag.status }}">{{ flag.status }}</span>
        </div>
        <p class="flag-description">{{ flag.description }}</p>
        
        <div class="flag-progress">
            <div class="progress-bar-container small">
                <div class="progress-bar" style="width: {{ flag.progress }}%">
                    <span class="progress-text">{{ flag.progress }}%</span>
                </div>
            </div>
        </div>
        
        <div class="flag-meta">
            <span>ğŸ“… {{ flag.target_date }}</span>
            <span>ğŸ·ï¸ {{ flag.category }}</span>
            <span>ğŸ¯ {{ flag.feasibility_score }}/100</span>
        </div>
        
        <div class="flag-actions">
            <a href="/flag/{{ flag.id }}" class="btn btn-sm btn-outline">æŸ¥çœ‹è¯¦æƒ…</a>
            <button onclick="showUpdateModal('{{ flag.id }}', {{ flag.progress }})" class="btn btn-sm btn-secondary">æ›´æ–°è¿›åº¦</button>
            <button onclick="deleteFlag('{{ flag.id }}')" class="btn btn-sm btn-danger">åˆ é™¤</button>
        </div>
    </div>
    {% endfor %}
</div>

<div class="modal" id="updateModal">
    <div class="modal-content">
        <span class="close" onclick="closeUpdateModal()">&times;</span>
        <h2>æ›´æ–°è¿›åº¦</h2>
        <form id="updateForm" onsubmit="submitUpdate(event)">
            <input type="hidden" id="updateFlagId">
            <div class="form-group">
                <label>è¿›åº¦ (0-100):</label>
                <input type="range" id="updateProgress" min="0" max="100" value="0" oninput="updateProgressLabel()">
                <span id="progressLabel">0%</span>
            </div>
            <div class="form-group">
                <label>å¤‡æ³¨:</label>
                <textarea id="updateNotes" rows="3" placeholder="è¾“å…¥å¤‡æ³¨ä¿¡æ¯..."></textarea>
            </div>
            <button type="submit" class="btn btn-primary">æ›´æ–°</button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function filterFlags() {
    const status = document.getElementById('statusFilter').value;
    const category = document.getElementById('categoryFilter').value;
    
    let url = '/flags';
    const params = [];
    if (status) params.push(`status=${encodeURIComponent(status)}`);
    if (category) params.push(`category=${encodeURIComponent(category)}`);
    if (params.length > 0) url += '?' + params.join('&');
    
    window.location.href = url;
}

function searchFlags() {
    const query = document.getElementById('searchInput').value.toLowerCase();
    const cards = document.querySelectorAll('.flag-card');
    
    cards.forEach(card => {
        const title = card.querySelector('h3').textContent.toLowerCase();
        const description = card.querySelector('.flag-description').textContent.toLowerCase();
        const category = card.querySelector('.flag-meta span:nth-child(2)').textContent.toLowerCase();
        
        if (title.includes(query) || description.includes(query) || category.includes(query)) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
}

function showUpdateModal(flagId, currentProgress) {
    document.getElementById('updateFlagId').value = flagId;
    document.getElementById('updateProgress').value = currentProgress;
    document.getElementById('progressLabel').textContent = currentProgress + '%';
    document.getElementById('updateModal').style.display = 'block';
}

function closeUpdateModal() {
    document.getElementById('updateModal').style.display = 'none';
}

function updateProgressLabel() {
    const progress = document.getElementById('updateProgress').value;
    document.getElementById('progressLabel').textContent = progress + '%';
}

function submitUpdate(event) {
    event.preventDefault();
    
    const flagId = document.getElementById('updateFlagId').value;
    const progress = document.getElementById('updateProgress').value;
    const notes = document.getElementById('updateNotes').value;
    
    fetch(`/update/${flagId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `progress=${progress}&notes=${encodeURIComponent(notes)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('è¿›åº¦æ›´æ–°æˆåŠŸï¼');
            closeUpdateModal();
            location.reload();
        } else {
            alert('æ›´æ–°å¤±è´¥ï¼š' + data.error);
        }
    })
    .catch(error => {
        alert('æ›´æ–°å¤±è´¥ï¼š' + error);
    });
}

function deleteFlag(flagId) {
    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªFlagå—ï¼Ÿ')) {
        fetch(`/delete/${flagId}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('åˆ é™¤æˆåŠŸï¼');
                location.reload();
            } else {
                alert('åˆ é™¤å¤±è´¥ï¼š' + data.error);
            }
        })
        .catch(error => {
            alert('åˆ é™¤å¤±è´¥ï¼š' + error);
        });
    }
}

window.onclick = function(event) {
    const modal = document.getElementById('updateModal');
    if (event.target == modal) {
        closeUpdateModal();
    }
}
</script>
{% endblock %}