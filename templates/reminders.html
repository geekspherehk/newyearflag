{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <h1>ğŸ”” æœˆåº¦æé†’</h1>
    <a href="/" class="btn btn-secondary">è¿”å›é¦–é¡µ</a>
</div>

{% if reminders %}
<div class="alert alert-warning">
    <strong>âš ï¸ æœ‰ {{ reminders|length }} ä¸ªflagséœ€è¦æ£€æŸ¥è¿›åº¦ï¼</strong>
    <p>è¿™äº›flagså·²ç»è¶…è¿‡30å¤©æœªæ›´æ–°ï¼Œå»ºè®®å°½å¿«æ£€æŸ¥è¿›åº¦ã€‚</p>
</div>

<div class="reminder-list">
    {% for flag in reminders %}
    <div class="reminder-card">
        <div class="reminder-header">
            <h3>{{ flag.title }}</h3>
            <span class="flag-status status-{{ flag.status }}">{{ flag.status }}</span>
        </div>
        
        <p class="flag-description">{{ flag.description }}</p>
        
        <div class="flag-progress">
            <div class="progress-bar-container small">
                <div class="progress-bar" style="width: {{ flag.progress }}%">
                    <span class="progress-text">{{ flag.progress }}%</span>
                </div>
            </div>
        </div>
        
        <div class="flag-meta">
            <span>ğŸ“… ç›®æ ‡æ—¥æœŸ: {{ flag.target_date }}</span>
            <span>ğŸ·ï¸ åˆ†ç±»: {{ flag.category }}</span>
            <span>ğŸ¯ å¯è¡Œæ€§: {{ flag.feasibility_score }}/100</span>
        </div>
        
        {% if flag.check_history %}
        <div class="last-check">
            <strong>ä¸Šæ¬¡æ£€æŸ¥:</strong> {{ flag.check_history[-1].date }}
        </div>
        {% endif %}
        
        <div class="reminder-actions">
            <a href="/flag/{{ flag.id[:8] }}" class="btn btn-primary">æŸ¥çœ‹è¯¦æƒ…</a>
            <button onclick="showUpdateModal('{{ flag.id[:8] }}', {{ flag.progress }})" class="btn btn-secondary">æ›´æ–°è¿›åº¦</button>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="alert alert-success">
    <strong>âœ… å¤ªæ£’äº†ï¼</strong>
    <p>ç›®å‰æ²¡æœ‰éœ€è¦æ£€æŸ¥çš„flagsï¼Œç»§ç»­ä¿æŒï¼</p>
</div>
{% endif %}

<div class="tips-section">
    <h2>ğŸ’¡ å®šæœŸæ£€æŸ¥çš„é‡è¦æ€§</h2>
    <div class="tips-grid">
        <div class="tip-card">
            <h3>ğŸ“ˆ è·Ÿè¸ªè¿›åº¦</h3>
            <p>å®šæœŸæ£€æŸ¥å¯ä»¥å¸®åŠ©ä½ äº†è§£ç›®æ ‡çš„å®Œæˆæƒ…å†µï¼ŒåŠæ—¶è°ƒæ•´ç­–ç•¥</p>
        </div>
        <div class="tip-card">
            <h3>ğŸ¯ ä¿æŒåŠ¨åŠ›</h3>
            <p>çœ‹åˆ°è¿›åº¦å¢é•¿ä¼šç»™ä½ å¸¦æ¥æˆå°±æ„Ÿå’Œç»§ç»­å‰è¿›çš„åŠ¨åŠ›</p>
        </div>
        <div class="tip-card">
            <h3>âš¡ åŠæ—¶è°ƒæ•´</h3>
            <p>å‘ç°é—®é¢˜æ—¶åŠæ—¶è°ƒæ•´ç›®æ ‡æˆ–æ–¹æ³•ï¼Œé¿å…æµªè´¹æ—¶é—´</p>
        </div>
        <div class="tip-card">
            <h3>ğŸ“Š ç§¯ç´¯ç»éªŒ</h3>
            <p>è®°å½•æ¯æ¬¡æ£€æŸ¥çš„å¤‡æ³¨ï¼Œç§¯ç´¯å®è´µçš„ç»éªŒæ•™è®­</p>
        </div>
    </div>
</div>

<div class="modal" id="updateModal">
    <div class="modal-content">
        <span class="close" onclick="closeUpdateModal()">&times;</span>
        <h2>æ›´æ–°è¿›åº¦</h2>
        <form id="updateForm" onsubmit="submitUpdate(event)">
            <input type="hidden" id="updateFlagId">
            <div class="form-group">
                <label>è¿›åº¦ (0-100):</label>
                <input type="range" id="updateProgress" min="0" max="100" value="0" oninput="updateProgressLabel()">
                <span id="progressLabel">0%</span>
            </div>
            <div class="form-group">
                <label>å¤‡æ³¨:</label>
                <textarea id="updateNotes" rows="3" placeholder="è¾“å…¥å¤‡æ³¨ä¿¡æ¯..."></textarea>
            </div>
            <button type="submit" class="btn btn-primary">æ›´æ–°</button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function showUpdateModal(flagId, currentProgress) {
    document.getElementById('updateFlagId').value = flagId;
    document.getElementById('updateProgress').value = currentProgress;
    document.getElementById('progressLabel').textContent = currentProgress + '%';
    document.getElementById('updateModal').style.display = 'block';
}

function closeUpdateModal() {
    document.getElementById('updateModal').style.display = 'none';
}

function updateProgressLabel() {
    const progress = document.getElementById('updateProgress').value;
    document.getElementById('progressLabel').textContent = progress + '%';
}

function submitUpdate(event) {
    event.preventDefault();
    
    const flagId = document.getElementById('updateFlagId').value;
    const progress = document.getElementById('updateProgress').value;
    const notes = document.getElementById('updateNotes').value;
    
    fetch(`/update/${flagId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `progress=${progress}&notes=${encodeURIComponent(notes)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('è¿›åº¦æ›´æ–°æˆåŠŸï¼');
            closeUpdateModal();
            location.reload();
        } else {
            alert('æ›´æ–°å¤±è´¥ï¼š' + data.error);
        }
    })
    .catch(error => {
        alert('æ›´æ–°å¤±è´¥ï¼š' + error);
    });
}

window.onclick = function(event) {
    const modal = document.getElementById('updateModal');
    if (event.target == modal) {
        closeUpdateModal();
    }
}
</script>
{% endblock %}